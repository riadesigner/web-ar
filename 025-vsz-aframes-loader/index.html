<!doctype HTML>
<html>
<link rel="icon" href="data:;base64,iVBORw0KGgo=">

<meta charset="utf-8">
<script src="js/aframe.min.js"></script>
<script src="js/aframe-ar.js"></script>
<script src="js/aframe-gif-shader.min.js"></script>
<script src="js/wad.js"></script>

<script src="js/aframe-extras.js"></script>

<style type="text/css">
*{box-sizing: border-box;}    
body{
    background: #2E3843;
}
.ar-loader{
    width: 100px;height: 100px;position: absolute;top:50%;left:50%;
    transform:translate(-50%,-50%) scale(1.0);opacity: 1;transition: .3s
}
.ar-loader.hidden{transform:translate(-50%,-50%) scale(1.3);opacity: 0;}
.ar-loader-icon {animation: ani-loader 1s linear infinite;}
.ar-loader-icon svg{width: 100%;height: 100%;max-width: 100%;}
@keyframes ani-loader{100%{transform:rotateZ(359deg);}}

#btn-press-me{
    position: absolute;
    font:.8rem arial;
    color:white;
    background: rgba(255,255,255,.2);
    border:1px solid white;
    border-radius: 50%;
    padding:10px 40px;
    bottom:20px;left: 50%;
    text-align: center;
    transform:translate(-50%,0);
    text-transform: uppercase;
}
</style>

<body style="margin: 0px; overflow: hidden;">

<div id='btn-press-me'>Нажми, чтобы <br>сменить&nbsp;картинку</div>

<div class="ar-loader ">
    <div class="ar-loader-icon">
<svg id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect x="57.7" y="70.05" width="6.24" height="19.36" rx="3.12" transform="translate(-23.6 25.61) rotate(-20)" style="fill:#ededed"/><rect x="36.06" y="10.59" width="6.24" height="19.36" rx="3.12" transform="translate(-4.57 14.62) rotate(-20)" style="fill:#ededed"/><rect x="67.22" y="64.55" width="6.24" height="19.36" rx="3.12" transform="translate(-31.26 62.58) rotate(-40)" style="fill:#ededed"/><rect x="26.54" y="16.08" width="6.24" height="19.36" rx="3.12" transform="translate(-9.62 25.09) rotate(-40)" style="fill:#ededed"/><rect x="74.28" y="56.14" width="6.24" height="19.36" rx="3.12" transform="translate(-18.3 99.94) rotate(-60)" style="fill:#ededed"/><rect x="19.48" y="24.5" width="6.24" height="19.36" rx="3.12" transform="translate(-18.3 36.66) rotate(-60)" style="fill:#ededed"/><rect x="78.04" y="45.81" width="6.24" height="19.36" rx="3.12" transform="translate(12.41 125.78) rotate(-80)" style="fill:#ededed"/><rect x="15.72" y="34.82" width="6.24" height="19.36" rx="3.12" transform="translate(-28.26 55.33) rotate(-80)" style="fill:#ededed"/><rect x="71.48" y="41.39" width="19.36" height="6.24" rx="3.12" transform="translate(-6.5 14.77) rotate(-10)" style="fill:#ededed"/><rect x="9.16" y="52.37" width="19.36" height="6.24" rx="3.12" transform="translate(-9.35 4.11) rotate(-10)" style="fill:#ededed"/><rect x="67.72" y="31.06" width="19.36" height="6.24" rx="3.12" transform="translate(-6.72 43.28) rotate(-30)" style="fill:#ededed"/><rect x="12.92" y="62.7" width="19.36" height="6.24" rx="3.12" transform="translate(-29.88 20.12) rotate(-30)" style="fill:#ededed"/><rect x="60.65" y="22.64" width="19.36" height="6.24" rx="3.12" transform="translate(5.39 63.08) rotate(-50)" style="fill:#ededed"/><rect x="19.98" y="71.12" width="19.36" height="6.24" rx="3.12" transform="translate(-46.27 49.24) rotate(-50)" style="fill:#ededed"/><rect x="51.14" y="17.15" width="19.36" height="6.24" rx="3.12" transform="translate(20.97 70.49) rotate(-70)" style="fill:#ededed"/><rect x="29.5" y="76.61" width="19.36" height="6.24" rx="3.12" transform="translate(-49.14 89.28) rotate(-70)" style="fill:#ededed"/><rect x="46.88" y="8.68" width="6.24" height="19.36" rx="3.12" style="fill:#ededed"/><rect x="46.88" y="71.96" width="6.24" height="19.36" rx="3.12" style="fill:#ededed"/></svg>
    </div>
</div>

<a-scene embedded vr-mode-ui="enabled: false;"

  arjs="debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;" 
  shadow="type: basic; castShadow: true">

<a-assets>
  <img id="circle-green-gif" src="images/circle-green.gif" />  
  <a-asset-item id="the-model-1" response-type="arraybuffer" src="models/f-01.gltf"></a-asset-item>
  <a-asset-item id="the-model-2" response-type="arraybuffer" src="models/f-02.gltf"></a-asset-item>
  <a-asset-item id="the-model-3" response-type="arraybuffer" src="models/f-03.gltf"></a-asset-item>
  <a-asset-item id="the-model-4" response-type="arraybuffer" src="models/f-04.gltf"></a-asset-item>
  <a-asset-item id="the-model-5" response-type="arraybuffer" src="models/f-05.gltf"></a-asset-item>
  <a-asset-item id="the-model-6" response-type="arraybuffer" src="models/f-06.gltf"></a-asset-item>
  <a-asset-item id="the-model-7" response-type="arraybuffer" src="models/f-07.gltf"></a-asset-item>
  <a-asset-item id="the-model-8" response-type="arraybuffer" src="models/f-08.gltf"></a-asset-item>

</a-assets>

<a-marker type="pattern" url="data/vsz-home.patt" registerevents id="marker-1"  >

    <a-entity countyside scale="1.6 1.6 1.6">

        <a-entity light="type: ambient; intensity: .6;"></a-entity>
        <a-entity light="type: directional;castShadow: true;intensity: 1.3; shadowCameraVisible: false;" 
          position="0 10 10 "></a-entity>

          <!-- group 1 -->
        <a-entity gltf-model="#the-model-1" id="model-1"
            shadow="receive: false" scale="0.001 0.001 0.001" 
            animation="property: position; to: 0 .9 -.6; dur: 800; easing: easeOutQuad; loop: true; delay:100; dir:alternate;"
            position="0 .4 -.6">
        </a-entity>

        <a-entity gltf-model="#the-model-2" id="model-2"
            shadow="receive: false" scale="0.001 0.001 0.001" 
            animation="property: position; to: 0.5 .6 0; dur: 600; easing: easeOutQuad; loop: true; dir:alternate;"
            position="0.5 .4 0">
        </a-entity>

        <a-entity gltf-model="#the-model-3" id="model-3"
            shadow="receive: false" scale="0.0008 0.0008 0.0008" 
            animation="property: position; to: -.3 .3 .5; dur: 700; easing: easeOutQuad; loop: true; delay:150; dir:alternate;"
            position="-.3 .1 .5">
        </a-entity>    
        
        <!-- group 2 -->    
        <a-entity gltf-model="#the-model-4" id="model-4"
            shadow="receive: false" scale="0.0012 0.0012 0.0012" 
            animation="property: position; to: -.2 .3 -.6; dur: 800; easing: easeOutQuad; loop: true; delay:100; dir:alternate;"
            position="-.2 0 -.6"
            visible="false">
        </a-entity>

        <a-entity gltf-model="#the-model-5" id="model-5"
            shadow="receive: false" scale="0.001 0.001 0.001" 
            animation="property: position; to: 0.5 .2 0; dur: 600; easing: easeOutQuad; loop: true; dir:alternate;"
            position="0.5 0 0"
            visible="false">
        </a-entity>

        <a-entity gltf-model="#the-model-8" id="model-6"
            shadow="receive: false" scale="0.0007 0.0007 0.0007" 
            animation="property: position; to: -.2 .3 .5; dur: 700; easing: easeOutQuad; loop: true; delay:150; dir:alternate;"
            position="-.2 .1 .5"
            visible="false">
        </a-entity>       

        <!-- group 3 -->
        <a-entity gltf-model="#the-model-7" id="model-7"
            shadow="receive: false" scale="0.001 0.001 0.001" 
            animation="property: position; to: 0.3 .3 0; dur: 600; easing: easeOutQuad; loop: true; dir:alternate;"
            position="0.3 0 0"
            visible="false">
        </a-entity>

        <a-entity gltf-model="#the-model-6" id="model-8"
            shadow="receive: false" scale="0.0008 0.0008 0.0008" 
            animation="property: position; to: -.3 .2 .5; dur: 700; easing: easeOutQuad; loop: true; delay:150; dir:alternate;"
            position="-.3 0 .5"
            visible="false">
        </a-entity> 

        <!-- group common -->
        <a-entity gltf-model="models/grass.gltf" scale="0.003 0.003 0.003" position=".6 0 -.4"></a-entity>
        <a-entity gltf-model="models/grass.gltf" scale="0.005 0.005 0.005" position=".6 0 .4"></a-entity>
        <a-entity gltf-model="models/grass.gltf" scale="0.003 0.003 0.003" position="-.2 0 .8"></a-entity>

        <a-circle position='0 -.1 0' shadow="receive: true" rotation="-90 0 0" 
        material="src: #circle-green-gif;shader:gif; opacity:1"></a-circle>

        </a-entity>

</a-marker>

<a-entity camera></a-entity>
    
</a-scene>


<script>

document.querySelector('a-assets').addEventListener('loaded',(e)=>{
    setTimeout(()=>{
        document.querySelector('.ar-loader').classList.add("hidden");
    },500)    
    console.log('ALL-LOADED');
});


var MODELKI = {
    init:function(current) {
        this.all_elements = {};
        this.all_models_group = [
            ['model-1','model-2','model-3'],
            ['model-4','model-5','model-6'],
            ['model-7','model-8']
        ];        
        this.sounds = [
            new Wad({source : 'snd/countryside.mp3'}),
            new Wad({source : 'snd/frogs.mp3'}),
            new Wad({source : 'snd/ducks.mp3'})            
            ];

        this.CURRENT = current||0;
        this.get_find_all_elements();
        this.behavior();
    },
    next:function() {
        if(this.CURRENT<this.all_models_group.length-1){
            this.CURRENT++;            
        }else{
            this.CURRENT=0;
        };
        this.toggle_3d_models();
        this.play_the_sound();
    },
    sounds_stop:function() {
        for (var s in this.sounds){
            this.sounds[s].stop();      
        }
    },
    // private    
    behavior:function() {
        document.body.addEventListener('click',()=>{
            this.next();
        })
    },
    get_find_all_elements:function() {        
        for (var i in this.all_models_group){
            var group = this.all_models_group[i];
            for (var el in group){
                var el_name = group[el];
                this.all_elements[el_name] = document.getElementById(el_name);
            }
        }
    },
    play_the_sound:function() {
        this.sounds_stop();
        this.sounds[this.CURRENT].play();
    },
    toggle_3d_models:function() {
        
        for(var i in this.all_elements){
            this.all_elements[i].object3D.visible = false;            
        };

        var  cur_group = this.all_models_group[this.CURRENT];
        for(var i in cur_group){
            var al_name = cur_group[i];
            this.all_elements[al_name].object3D.visible = true;
        }
    }
};



MODELKI.init(1);

AFRAME.registerComponent('registerevents', {
    init: function () 
    {
        let marker = this.el;

        marker.addEventListener('markerFound', function(e) {
            var id = e.srcElement.id;
            if(id==='marker-1'){                
                MODELKI.next();

            }       
        });

        marker.addEventListener('markerLost', function(e) {
            var id = e.srcElement.id;            
            if(id==='marker-1'){
                MODELKI.sounds_stop();                
            }       
        });
    }
});    


</script>



</body>
</html>